pipeline {
    agent any

    // ‚úÖ QUICK WIN: Move input to parameters block
    // This allows the pipeline to be triggered automatically by Git webhooks
    parameters {
        string(
            name: 'RUNNER',
            defaultValue: 'RCLAYE',
            description: 'Identify who triggered this build'
        )
        choice(
            name: 'DEPLOY',
            choices: ['Apply', 'Destroy'],
            description: 'Choose Apply to deploy or Destroy to tear down'
        )
    }

    environment {
        PATH = "${PATH}:${getTerraformPath()}"
        VERSION = "1.0.${BUILD_NUMBER}"
        TERRAFORM_DIR = "instances"
        AWS_REGION = "us-east-1"
    }

    stages {
        stage('üé¨ Initialize Deployment') {
            steps {
                // ‚úÖ No more waiting! Parameters are already set
                echo "Pipeline initialized by: ${params.RUNNER}"
                echo "Action: ${params.DEPLOY}"
            }
        }

        stage('üîß Prepare Infrastructure') {
            steps {
                echo "üîß INFRASTRUCTURE PREPARATION - User: ${params.RUNNER}"
                sh """
                    cd ${TERRAFORM_DIR}
                    terraform init -migrate-state
                """
            }
        }

        stage('‚úÖ Validate Terraform') {
            steps {
                echo "‚úÖ VALIDATING TERRAFORM CONFIGURATION - User: ${params.RUNNER}"
                sh """
                    cd ${TERRAFORM_DIR}
                    terraform validate
                    terraform fmt -check -recursive
                """
            }
            post {
                success {
                    echo "‚úÖ Terraform configuration is valid"
                }
                failure {
                    echo "‚ùå Terraform validation failed - check syntax and formatting"
                }
            }
        }

        stage('üìã Plan Deployment') {
            when {
                expression { params.DEPLOY == 'Apply' }
            }
            steps {
                withCredentials([file(credentialsId: 'k8-clixxx', variable: 'TFVARS_FILE')]) {
                    echo "üìã DEPLOYMENT PLANNING - User: ${params.RUNNER}"
                    sh """
                        cd ${TERRAFORM_DIR}
                        terraform plan \
                          -var-file="\$TFVARS_FILE" \
                          -out=tfplan \
                          -input=false
                    """
                }
            }
            // ‚úÖ QUICK WIN: Save the plan for audit trail
            post {
                success {
                    archiveArtifacts artifacts: "${TERRAFORM_DIR}/tfplan", allowEmptyArchive: true
                }
            }
        }

        stage('üöÄ Deploy Infrastructure') {
            when {
                expression { params.DEPLOY == 'Apply' }
            }
            steps {
                withCredentials([file(credentialsId: 'k8-clixxx', variable: 'TFVARS_FILE')]) {
                    echo "üöÄ DEPLOYING K8S INFRASTRUCTURE - User: ${params.RUNNER}"
                    sh """
                        cd ${TERRAFORM_DIR}
                        terraform apply -input=false tfplan
                    """
                }
            }
            post {
                success {
                    echo """‚úÖ TERRAFORM APPLY SUCCESS
Infrastructure deployed! Waiting for K8s cluster to initialize...
User: ${params.RUNNER}
Job: ${env.JOB_NAME} [${env.BUILD_NUMBER}]"""
                }
                failure {
                    echo """‚ùå TERRAFORM APPLY FAILED
Infrastructure deployment failed.
User: ${params.RUNNER}
Job: ${env.JOB_NAME} [${env.BUILD_NUMBER}]"""
                }
            }
        }

        stage('üéâ Deployment Complete') {
            when {
                expression { params.DEPLOY == 'Apply' }
            }
            steps {
                script {
                    def appUrl = sh(
                        script: "cd ${TERRAFORM_DIR} && terraform output -raw application_url 2>/dev/null || echo 'https://ecs.stack-claye.com'",
                        returnStdout: true
                    ).trim()
                    
                    def grafanaUrl = sh(
                        script: "cd ${TERRAFORM_DIR} && terraform output -raw grafana_url 2>/dev/null || echo 'https://grafana.stack-claye.com'",
                        returnStdout: true
                    ).trim()
                    
                    def bastionIp = sh(
                        script: "cd ${TERRAFORM_DIR} && terraform output -raw bastion_public_ip 2>/dev/null || echo 'N/A'",
                        returnStdout: true
                    ).trim()
                    
                    def masterIp = sh(
                        script: "cd ${TERRAFORM_DIR} && terraform output -raw k8s_master_private_ip 2>/dev/null || echo 'N/A'",
                        returnStdout: true
                    ).trim()
                    
                    echo """
========================================
üéâ INFRASTRUCTURE DEPLOYED!
========================================
üåê Application URL: ${appUrl}
üìä Grafana URL: ${grafanaUrl} (admin/admin123)
üîë Bastion IP: ${bastionIp}
üñ•Ô∏è  Master IP: ${masterIp}
üë§ Deployed by: ${params.RUNNER}

‚è≥ NOTE: K8s cluster is still initializing (~15-20 min)
   Monitor progress:
   ssh -J ubuntu@${bastionIp} ubuntu@${masterIp}
   sudo tail -f /var/log/combined-master-init.log
========================================
                    """
                }
            }
        }

        stage('üóëÔ∏è Destroy Infrastructure') {
            when {
                expression { params.DEPLOY == 'Destroy' }
            }
            steps {
                // ‚úÖ Keep confirmation for destroy - this is good practice!
                script {
                    input(
                        id: 'destroy_confirm',
                        message: "‚ö†Ô∏è Are you sure you want to DESTROY the K8s cluster?",
                        ok: "Yes, Destroy"
                    )
                }
                withCredentials([file(credentialsId: 'k8-clixxx', variable: 'TFVARS_FILE')]) {
                    echo "üóëÔ∏è DESTROYING INFRASTRUCTURE - User: ${params.RUNNER}"
                    sh """
                        cd ${TERRAFORM_DIR}
                        
                        echo "Cleaning up SSM parameters..."
                        aws ssm delete-parameter --name '/clixx/k8s-join-command' --region ${AWS_REGION} || true
                        
                        echo "Running terraform destroy..."
                        terraform destroy \
                          -var-file="\$TFVARS_FILE" \
                          -auto-approve
                    """
                }
            }
            post {
                success {
                    echo "‚úÖ INFRASTRUCTURE DESTROYED SUCCESSFULLY"
                }
                failure {
                    echo "‚ùå DESTROY FAILED - Manual cleanup may be required"
                }
            }
        }
    }

    post {
        always {
            echo "Pipeline completed. Result: ${currentBuild.currentResult}"
        }
    }
}

def getTerraformPath() {
    return tool(name: 'terraform-14', type: 'terraform')
}