pipeline {
    agent any

    environment {
        PATH = "${PATH}:${getTerraformPath()}"
        VERSION = "1.0.${BUILD_NUMBER}"
        TERRAFORM_DIR = "instances"
        AWS_REGION = "us-east-1"
    }

    stages {
        stage('üé¨ Initialize Deployment') {
            steps {
                script {
                    def userInput = input(
                        id: 'InitParams',
                        message: 'Kubernetes Pipeline Parameters',
                        parameters: [
                            [$class: 'StringParameterDefinition',
                             name: 'RUNNER',
                             defaultValue: 'RCLAYE',
                             description: 'Identify the runner'],
                            [$class: 'ChoiceParameterDefinition',
                             name: 'DEPLOY',
                             choices: "Apply\nDestroy",
                             description: 'Choose Apply or Destroy']
                        ]
                    )
                    env.RUNNER = userInput['RUNNER']
                    env.DEPLOY = userInput['DEPLOY']
                }
                slackSend(
                    channel: '#stackjenkins',
                    color: '#FFFF01',
                    message: """K8S PIPELINE INITIALIZED
User: ${env.RUNNER}
Action: ${env.DEPLOY}
Job: ${env.JOB_NAME} [${env.BUILD_NUMBER}]"""
                )
                echo "Pipeline initialized by: ${env.RUNNER}"
                echo "Action: ${env.DEPLOY}"
            }
        }

        stage('üîß Prepare Infrastructure') {
            steps {
                slackSend(
                    channel: '#stackjenkins',
                    color: '#3498DB',
                    message: """TERRAFORM INIT
Status: Started
User: ${env.RUNNER}
Job: ${env.JOB_NAME} [${env.BUILD_NUMBER}]"""
                )
                echo "üîß INFRASTRUCTURE PREPARATION - User: ${env.RUNNER}"
                sh """
                    cd ${TERRAFORM_DIR}
                    terraform init -migrate-state
                """
            }
        }

        stage('üìã Plan Deployment') {
            when {
                expression { env.DEPLOY == 'Apply' }
            }
            steps {
                withCredentials([file(credentialsId: 'k8-clixxx', variable: 'TFVARS_FILE')]) {
                    slackSend(
                        channel: '#stackjenkins',
                        color: '#F39C12',
                        message: """TERRAFORM PLAN
Status: Started
User: ${env.RUNNER}
Job: ${env.JOB_NAME} [${env.BUILD_NUMBER}]"""
                    )
                    echo "üìã DEPLOYMENT PLANNING - User: ${env.RUNNER}"
                    sh """
                        cd ${TERRAFORM_DIR}
                        terraform plan \
                          -var-file="\$TFVARS_FILE" \
                          -out=tfplan \
                          -input=false
                    """
                }
            }
        }

        stage('üöÄ Deploy Infrastructure') {
            when {
                expression { env.DEPLOY == 'Apply' }
            }
            steps {
                withCredentials([file(credentialsId: 'k8-clixxx', variable: 'TFVARS_FILE')]) {
                    slackSend(
                        channel: '#stackjenkins',
                        color: '#2ECC71',
                        message: """TERRAFORM APPLY
Status: Started
User: ${env.RUNNER}
Job: ${env.JOB_NAME} [${env.BUILD_NUMBER}]"""
                    )
                    echo "üöÄ DEPLOYING K8S INFRASTRUCTURE - User: ${env.RUNNER}"
                    sh """
                        cd ${TERRAFORM_DIR}
                        terraform apply -input=false tfplan
                    """
                }
            }
            post {
                success {
                    script {
                        def appUrl = sh(
                            script: "cd ${TERRAFORM_DIR} && terraform output -raw application_url 2>/dev/null || echo 'https://ecs.stack-claye.com'",
                            returnStdout: true
                        ).trim()
                        
                        def grafanaUrl = sh(
                            script: "cd ${TERRAFORM_DIR} && terraform output -raw grafana_url 2>/dev/null || echo 'https://grafana.stack-claye.com'",
                            returnStdout: true
                        ).trim()
                        
                        slackSend(
                            channel: '#stackjenkins',
                            color: '#2ECC71',
                            message: """‚úÖ TERRAFORM APPLY SUCCESS
Infrastructure deployed!
üåê CliXX App: ${appUrl}
üìä Grafana: ${grafanaUrl}
User: ${env.RUNNER}
Job: ${env.JOB_NAME} [${env.BUILD_NUMBER}]"""
                        )
                    }
                    echo """‚úÖ TERRAFORM APPLY SUCCESS
Infrastructure deployed! Waiting for K8s cluster to initialize...
User: ${env.RUNNER}
Job: ${env.JOB_NAME} [${env.BUILD_NUMBER}]"""
                }
                failure {
                    slackSend(
                        channel: '#stackjenkins',
                        color: '#C0392B',
                        message: """‚ùå TERRAFORM APPLY FAILED
Infrastructure deployment failed.
User: ${env.RUNNER}
Job: ${env.JOB_NAME} [${env.BUILD_NUMBER}]"""
                    )
                    echo """‚ùå TERRAFORM APPLY FAILED
Infrastructure deployment failed.
User: ${env.RUNNER}
Job: ${env.JOB_NAME} [${env.BUILD_NUMBER}]"""
                }
            }
        }

        stage('üéâ Deployment Complete') {
            when {
                expression { env.DEPLOY == 'Apply' }
            }
            steps {
                script {
                    def appUrl = sh(
                        script: "cd ${TERRAFORM_DIR} && terraform output -raw application_url 2>/dev/null || echo 'https://ecs.stack-claye.com'",
                        returnStdout: true
                    ).trim()
                    
                    def grafanaUrl = sh(
                        script: "cd ${TERRAFORM_DIR} && terraform output -raw grafana_url 2>/dev/null || echo 'https://grafana.stack-claye.com'",
                        returnStdout: true
                    ).trim()
                    
                    def bastionIp = sh(
                        script: "cd ${TERRAFORM_DIR} && terraform output -raw bastion_public_ip 2>/dev/null || echo 'N/A'",
                        returnStdout: true
                    ).trim()
                    
                    def masterIp = sh(
                        script: "cd ${TERRAFORM_DIR} && terraform output -raw k8s_master_private_ip 2>/dev/null || echo 'N/A'",
                        returnStdout: true
                    ).trim()
                    
                    echo """
========================================
üéâ INFRASTRUCTURE DEPLOYED!
========================================
üåê Application URL: ${appUrl}
üìä Grafana URL: ${grafanaUrl} (admin/admin123)
üîë Bastion IP: ${bastionIp}
üñ•Ô∏è  Master IP: ${masterIp}
üë§ Deployed by: ${env.RUNNER}

‚è≥ NOTE: K8s cluster is still initializing (~15-20 min)
   Monitor progress:
   ssh -J ubuntu@${bastionIp} ubuntu@${masterIp}
   sudo tail -f /var/log/combined-master-init.log
========================================
                    """
                }
            }
        }

        stage('üóëÔ∏è Destroy Infrastructure') {
            when {
                expression { env.DEPLOY == 'Destroy' }
            }
            steps {
                script {
                    input(
                        id: 'destroy_confirm',
                        message: "‚ö†Ô∏è Are you sure you want to DESTROY the K8s cluster?",
                        ok: "Yes, Destroy"
                    )
                }
                withCredentials([file(credentialsId: 'k8-clixxx', variable: 'TFVARS_FILE')]) {
                    slackSend(
                        channel: '#stackjenkins',
                        color: '#E74C3C',
                        message: """üóëÔ∏è TERRAFORM DESTROY
Status: Started
User: ${env.RUNNER}
Job: ${env.JOB_NAME} [${env.BUILD_NUMBER}]"""
                    )
                    echo "üóëÔ∏è DESTROYING INFRASTRUCTURE - User: ${env.RUNNER}"
                    sh """
                        cd ${TERRAFORM_DIR}
                        
                        echo "Cleaning up SSM parameters..."
                        aws ssm delete-parameter --name '/clixx/k8s-join-command' --region ${AWS_REGION} || true
                        
                        echo "Running terraform destroy..."
                        terraform destroy \
                          -var-file="\$TFVARS_FILE" \
                          -auto-approve
                    """
                }
            }
            post {
                success {
                    slackSend(
                        channel: '#stackjenkins',
                        color: '#9B59B6',
                        message: """‚úÖ INFRASTRUCTURE DESTROYED SUCCESSFULLY
User: ${env.RUNNER}
Job: ${env.JOB_NAME} [${env.BUILD_NUMBER}]"""
                    )
                    echo "‚úÖ INFRASTRUCTURE DESTROYED SUCCESSFULLY"
                }
                failure {
                    slackSend(
                        channel: '#stackjenkins',
                        color: '#C0392B',
                        message: """‚ùå DESTROY FAILED - Manual cleanup may be required
User: ${env.RUNNER}
Job: ${env.JOB_NAME} [${env.BUILD_NUMBER}]"""
                    )
                    echo "‚ùå DESTROY FAILED - Manual cleanup may be required"
                }
            }
        }
    }

    post {
        cleanup {
            script {
                def destroyInfra = false

                if (currentBuild.currentResult == 'SUCCESS' && env.DEPLOY == 'Apply') {
                    try {
                        input(
                            id: 'destroy_confirm',
                            message: "üéâ Deployment successful! Destroy environment?",
                            parameters: [
                                [$class: 'BooleanParameterDefinition', 
                                 defaultValue: false, 
                                 description: 'Run terraform destroy?', 
                                 name: 'confirm']
                            ]
                        )
                        destroyInfra = true
                        slackSend(
                            channel: '#stackjenkins',
                            color: '#E74C3C',
                            message: "DESTROY APPROVED by ${env.RUNNER}. Removing infrastructure."
                        )
                        echo "üóëÔ∏è DESTROY APPROVED by ${env.RUNNER}"
                    } catch(err) {
                        destroyInfra = false
                        slackSend(
                            channel: '#stackjenkins',
                            color: '#2ECC71',
                            message: "Destroy not approved. Infrastructure remains."
                        )
                        echo "‚úÖ Infrastructure remains deployed"
                    }
                } else if (currentBuild.currentResult == 'FAILURE') {
                    destroyInfra = true
                    slackSend(
                        channel: '#stackjenkins',
                        color: '#C0392B',
                        message: "PIPELINE FAILED. Triggering automatic cleanup and destroy."
                    )
                    echo "‚ö†Ô∏è PIPELINE FAILED - Auto cleanup triggered"
                }

                if (destroyInfra) {
                    echo "üßπ Proceeding with Infrastructure Cleanup..."
                    withCredentials([file(credentialsId: 'k8-clixxx', variable: 'TFVARS_FILE')]) {
                        try {
                            sh """
                                set -e
                                cd ${TERRAFORM_DIR}
                                
                                echo "Cleaning up SSM parameters..."
                                aws ssm delete-parameter --name '/clixx/k8s-join-command' --region ${AWS_REGION} 2>/dev/null || true
                                
                                echo "Running infrastructure destroy..."
                                terraform destroy \
                                  -var-file="\$TFVARS_FILE" \
                                  -auto-approve
                            """
                            slackSend(
                                channel: '#stackjenkins',
                                color: '#9B59B6',
                                message: "${env.RUNNER}'s TERRAFORM DESTROY SUCCESSFUL."
                            )
                            echo "‚úÖ INFRASTRUCTURE DESTROYED SUCCESSFULLY"
                        } catch (e) {
                            slackSend(
                                channel: '#stackjenkins',
                                color: '#C0392B',
                                message: "ERROR: TERRAFORM DESTROY FAILED. Manual cleanup may be required."
                            )
                            echo "‚ùå DESTROY FAILED - Manual cleanup required"
                            throw e
                        }
                    }
                }
            }
        }
    }
}

def getTerraformPath() {
    return tool(name: 'terraform-14', type: 'terraform')
}