pipeline {
    agent any

    environment {
        PATH = "${PATH}:${getTerraformPath()}"
        VERSION = "1.0.${BUILD_NUMBER}"
        TERRAFORM_DIR = "instances"
        AWS_REGION = "us-east-1"
        ECR_IMAGE = "924305315126.dkr.ecr.us-east-1.amazonaws.com/clixx-repository2:clixx-image-1.0.42"
    }

    stages {
        stage('üé¨ Initialize Deployment') {
            steps {
                script {
                    def userInput = input(
                        id: 'InitParams',
                        message: 'Kubernetes Pipeline Parameters',
                        parameters: [
                            [$class: 'StringParameterDefinition',
                             name: 'RUNNER',
                             defaultValue: 'RCLAYE',
                             description: 'Identify the runner'],
                            [$class: 'ChoiceParameterDefinition',
                             name: 'DEPLOY',
                             choices: "Apply\nDestroy",
                             description: 'Choose Apply or Destroy']
                        ]
                    )
                    env.RUNNER = userInput['RUNNER']
                    env.DEPLOY = userInput['DEPLOY']
                }
                echo "Pipeline initialized by: ${env.RUNNER}"
                echo "Action: ${env.DEPLOY}"
            }
        }

        stage('üîß Prepare Infrastructure') {
            steps {
                echo "üîß INFRASTRUCTURE PREPARATION - User: ${env.RUNNER}"
                sh """
                    cd ${TERRAFORM_DIR}
                    terraform init -migrate-state
                """
            }
        }

        stage('‚úÖ Validate Terraform') {
            steps {
                echo "‚úÖ VALIDATING TERRAFORM CONFIGURATION - User: ${env.RUNNER}"
                sh """
                    cd ${TERRAFORM_DIR}
                    terraform validate
                """
                script {
                    // Format check - warn but don't fail
                    def fmtResult = sh(
                        script: "cd ${TERRAFORM_DIR} && terraform fmt -check -recursive",
                        returnStatus: true
                    )
                    if (fmtResult != 0) {
                        echo "‚ö†Ô∏è WARNING: Some Terraform files need formatting. Run 'terraform fmt -recursive' locally."
                    }
                }
            }
            post {
                success {
                    echo "‚úÖ Terraform configuration is valid"
                }
                failure {
                    echo "‚ùå Terraform validation failed - check syntax"
                }
            }
        }

        stage('üîí Security Scan') {
            when {
                expression { env.DEPLOY == 'Apply' }
            }
            steps {
                echo "üîí SECURITY SCANNING - User: ${env.RUNNER}"
                script {
                    // Install Trivy if not present
                    sh '''
                        if ! command -v trivy &> /dev/null; then
                            echo "Installing Trivy..."
                            curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
                        fi
                        trivy --version
                    '''
                    
                    // Scan Terraform files for misconfigurations
                    echo "üìÅ Scanning Terraform configurations..."
                    def tfScan = sh(
                        script: "trivy config ${TERRAFORM_DIR} --severity HIGH,CRITICAL --exit-code 0",
                        returnStatus: true
                    )
                    
                    // Scan Kubernetes manifests
                    echo "‚ò∏Ô∏è Scanning Kubernetes manifests..."
                    def k8sScan = sh(
                        script: "trivy config ${TERRAFORM_DIR}/clixx-deployment.yaml ${TERRAFORM_DIR}/clixx-service.yaml --severity HIGH,CRITICAL --exit-code 0",
                        returnStatus: true
                    )
                    
                    // Scan container image (requires ECR auth)
                    echo "üê≥ Scanning container image..."
                    sh """
                        aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin 924305315126.dkr.ecr.${AWS_REGION}.amazonaws.com
                    """
                    def imageScan = sh(
                        script: "trivy image ${ECR_IMAGE} --severity HIGH,CRITICAL --exit-code 0",
                        returnStatus: true
                    )
                    
                    // Report summary
                    if (tfScan != 0 || k8sScan != 0 || imageScan != 0) {
                        echo "‚ö†Ô∏è Security scan found issues - review above output"
                    } else {
                        echo "‚úÖ No HIGH/CRITICAL vulnerabilities found"
                    }
                }
            }
            post {
                success {
                    echo "üîí Security scan completed"
                }
                failure {
                    echo "‚ö†Ô∏è Security scan encountered an error"
                }
            }
        }

        stage('üìã Plan Deployment') {
            when {
                expression { env.DEPLOY == 'Apply' }
            }
            steps {
                withCredentials([file(credentialsId: 'k8-clixxx', variable: 'TFVARS_FILE')]) {
                    echo "üìã DEPLOYMENT PLANNING - User: ${env.RUNNER}"
                    sh """
                        cd ${TERRAFORM_DIR}
                        terraform plan \
                          -var-file="\$TFVARS_FILE" \
                          -out=tfplan \
                          -input=false
                    """
                }
            }
        }

        stage('üöÄ Deploy Infrastructure') {
            when {
                expression { env.DEPLOY == 'Apply' }
            }
            steps {
                withCredentials([file(credentialsId: 'k8-clixxx', variable: 'TFVARS_FILE')]) {
                    echo "üöÄ DEPLOYING K8S INFRASTRUCTURE - User: ${env.RUNNER}"
                    sh """
                        cd ${TERRAFORM_DIR}
                        terraform apply -input=false tfplan
                    """
                }
            }
            post {
                success {
                    echo """‚úÖ TERRAFORM APPLY SUCCESS
Infrastructure deployed! Waiting for K8s cluster to initialize...
User: ${env.RUNNER}
Job: ${env.JOB_NAME} [${env.BUILD_NUMBER}]"""
                }
                failure {
                    echo """‚ùå TERRAFORM APPLY FAILED
Infrastructure deployment failed.
User: ${env.RUNNER}
Job: ${env.JOB_NAME} [${env.BUILD_NUMBER}]"""
                }
            }
        }

        stage('üéâ Deployment Complete') {
            when {
                expression { env.DEPLOY == 'Apply' }
            }
            steps {
                script {
                    def appUrl = sh(
                        script: "cd ${TERRAFORM_DIR} && terraform output -raw application_url 2>/dev/null || echo 'https://ecs.stack-claye.com'",
                        returnStdout: true
                    ).trim()
                    
                    def grafanaUrl = sh(
                        script: "cd ${TERRAFORM_DIR} && terraform output -raw grafana_url 2>/dev/null || echo 'https://grafana.stack-claye.com'",
                        returnStdout: true
                    ).trim()
                    
                    def bastionIp = sh(
                        script: "cd ${TERRAFORM_DIR} && terraform output -raw bastion_public_ip 2>/dev/null || echo 'N/A'",
                        returnStdout: true
                    ).trim()
                    
                    def masterIp = sh(
                        script: "cd ${TERRAFORM_DIR} && terraform output -raw k8s_master_private_ip 2>/dev/null || echo 'N/A'",
                        returnStdout: true
                    ).trim()
                    
                    echo """
========================================
üéâ INFRASTRUCTURE DEPLOYED!
========================================
üåê Application URL: ${appUrl}
üìä Grafana URL: ${grafanaUrl} (admin/admin123)
üîë Bastion IP: ${bastionIp}
üñ•Ô∏è  Master IP: ${masterIp}
üë§ Deployed by: ${env.RUNNER}

‚è≥ NOTE: K8s cluster is still initializing (~15-20 min)
   Monitor progress:
   ssh -J ubuntu@${bastionIp} ubuntu@${masterIp}
   sudo tail -f /var/log/combined-master-init.log
========================================
                    """
                }
            }
        }

        stage('üóëÔ∏è Destroy Infrastructure') {
            when {
                expression { env.DEPLOY == 'Destroy' }
            }
            steps {
                script {
                    input(
                        id: 'destroy_confirm',
                        message: "‚ö†Ô∏è Are you sure you want to DESTROY the K8s cluster?",
                        ok: "Yes, Destroy"
                    )
                }
                withCredentials([file(credentialsId: 'k8-clixxx', variable: 'TFVARS_FILE')]) {
                    echo "üóëÔ∏è DESTROYING INFRASTRUCTURE - User: ${env.RUNNER}"
                    sh """
                        cd ${TERRAFORM_DIR}
                        
                        echo "Cleaning up SSM parameters..."
                        aws ssm delete-parameter --name '/clixx/k8s-join-command' --region ${AWS_REGION} || true
                        
                        echo "Running terraform destroy..."
                        terraform destroy \
                          -var-file="\$TFVARS_FILE" \
                          -auto-approve
                    """
                }
            }
            post {
                success {
                    echo "‚úÖ INFRASTRUCTURE DESTROYED SUCCESSFULLY"
                }
                failure {
                    echo "‚ùå DESTROY FAILED - Manual cleanup may be required"
                }
            }
        }
    }

    post {
        cleanup {
            script {
                def destroyInfra = false

                if (currentBuild.currentResult == 'SUCCESS' && env.DEPLOY == 'Apply') {
                    try {
                        input(
                            id: 'destroy_confirm',
                            message: "üéâ Deployment successful! Destroy environment?",
                            parameters: [
                                [$class: 'BooleanParameterDefinition', 
                                 defaultValue: false, 
                                 description: 'Run terraform destroy?', 
                                 name: 'confirm']
                            ]
                        )
                        destroyInfra = true
                        echo "üóëÔ∏è DESTROY APPROVED by ${env.RUNNER}"
                    } catch(err) {
                        destroyInfra = false
                        echo "‚úÖ Infrastructure remains deployed"
                    }
                } else if (currentBuild.currentResult == 'FAILURE') {
                    destroyInfra = true
                    echo "‚ö†Ô∏è PIPELINE FAILED - Auto cleanup triggered"
                }

                if (destroyInfra) {
                    echo "üßπ Proceeding with Infrastructure Cleanup..."
                    withCredentials([file(credentialsId: 'k8-clixxx', variable: 'TFVARS_FILE')]) {
                        try {
                            sh """
                                set -e
                                cd ${TERRAFORM_DIR}
                                
                                echo "Cleaning up SSM parameters..."
                                aws ssm delete-parameter --name '/clixx/k8s-join-command' --region ${AWS_REGION} 2>/dev/null || true
                                
                                echo "Running infrastructure destroy..."
                                terraform destroy \
                                  -var-file="\$TFVARS_FILE" \
                                  -auto-approve
                            """
                            echo "‚úÖ INFRASTRUCTURE DESTROYED SUCCESSFULLY"
                        } catch (e) {
                            echo "‚ùå DESTROY FAILED - Manual cleanup required"
                            throw e
                        }
                    }
                }
            }
        }
    }
}

def getTerraformPath() {
    return tool(name: 'terraform-14', type: 'terraform')
}